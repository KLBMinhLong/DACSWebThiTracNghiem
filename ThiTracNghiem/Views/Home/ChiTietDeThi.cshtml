@model DeThi
@{
    var danhSachLichSu = ViewBag.LichSuDangLam as List<ThiTracNghiem.Models.LichSuLamBai>;
    var dangLam = danhSachLichSu?.FirstOrDefault(l => l.DeThiId == Model.Id);
}

<div class="container mt-4">
    <h2 class="mb-4 text-center">@Model.TenDeThi</h2>

    <ul class="list-group mb-4">
        <li class="list-group-item"><strong>S·ªë c√¢u h·ªèi:</strong> @Model.SoLuongCauHoi</li>
        <li class="list-group-item"><strong>Th·ªùi gian l√†m b√†i:</strong> @Model.ThoiGianLamBai ph√∫t</li>
        <li class="list-group-item"><strong>Ng√†y t·∫°o:</strong> @Model.NgayTao.ToString("dd/MM/yyyy")</li>
    </ul>

    <div class="text-center">

        @if (dangLam != null)
        {
            <div class="alert alert-warning">
                üïí B·∫°n ƒëang l√†m d·ªü ƒë·ªÅ n√†y t·ª´ @dangLam.NgayBatDau.ToString("HH:mm dd/MM")
            </div>
            <a href="/Thi/LamBai?id=@Model.Id" class="btn btn-warning">Ti·∫øp t·ª•c l√†m b√†i</a>
        }
        else
        {
            <a href="/Thi/LamBai?id=@Model.Id" class="btn btn-success">B·∫Øt ƒë·∫ßu l√†m b√†i</a>
        }
    </div>
    <hr>
    <h4 class="mt-4">B√¨nh lu·∫≠n</h4>
    <div>
        <form id="form-binhluan">
            <input type="hidden" name="deThiId" value="@Model.Id" />
            <textarea name="noiDung" class="form-control mb-2" required></textarea>
            <button type="submit" class="btn btn-primary btn-sm">G·ª≠i b√¨nh lu·∫≠n</button>
        </form>

        <div id="ds-binhluan" class="mt-4"></div>
    </div>
</div>

@section Scripts {
    <script>
        const deThiId = @Model.Id;

        function taiBinhLuan() {
            fetch('/BinhLuan/DanhSach?deThiId=' + deThiId)
                .then(res => res.text())
                .then(html => document.getElementById('ds-binhluan').innerHTML = html);
        }

        // G·ª≠i b√¨nh lu·∫≠n
        document.getElementById("form-binhluan").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/BinhLuan/Create', {
                method: 'POST',
                body: formData
            })
                .then(res => res.text())
                .then(html => {
                    this.reset();
                    document.getElementById('ds-binhluan').innerHTML = html;
                });
        });

        function xoaBinhLuan(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;

            fetch('/BinhLuan/Delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'id=' + id
            })
                .then(res => res.text())
                .then(html => {
                    document.getElementById('ds-binhluan').innerHTML = html;
                });
        }

        // T·∫£i l·∫°i m·ªói 10 gi√¢y
        setInterval(taiBinhLuan, 10000);
        taiBinhLuan(); // load l·∫ßn ƒë·∫ßu
    </script>
}
