@model List<ChiTietLamBai>
@{
    ViewBag.Title = "Làm bài thi";
    var lichSuId = ViewBag.LichSuId;
    var thoiGian = (int)ViewBag.ThoiGianConLai;
}

<div class="container mt-4">
    <h3 class="text-center mb-4">Bài Thi</h3>

    <div class="alert alert-info text-center">
        Thời gian còn lại: <span id="countdown" class="fw-bold text-danger"></span>
    </div>

    <form id="formThi">
        @for (int i = 0; i < Model.Count; i++)
        {
            var cauHoi = Model[i].CauHoi;
            var dapAnChon = Model[i].DapAnChon;

            <div class="card mb-4 shadow-sm p-3">
                <p><strong>Câu @(@i + 1):</strong> @cauHoi.NoiDung</p>
                @if (!string.IsNullOrEmpty(cauHoi?.HinhAnhUrl))
                {
                    <img src="@cauHoi.HinhAnhUrl" alt="Hình ảnh câu hỏi" class="img-fluid mb-2" width="30%"/>
                }

                @if (!string.IsNullOrEmpty(cauHoi?.AudioUrl))
                {
                    <audio controls class="mb-2">
                        <source src="@cauHoi.AudioUrl" type="audio/mpeg" />
                        Trình duyệt không hỗ trợ audio.
                    </audio>
                }
                <input type="hidden" name="CauHoiId" value="@cauHoi.Id" />

                @foreach (var dapAn in new[] { "A", "B", "C", "D" })
                {
                    var noiDung = typeof(CauHoi).GetProperty("DapAn" + dapAn).GetValue(cauHoi)?.ToString();
                    var isChecked = (dapAn == dapAnChon) ? "checked" : "";

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dapAn_@cauHoi.Id" value="@dapAn"
                               @Html.Raw(isChecked)
                               onchange="luuDapAn(@lichSuId, @cauHoi.Id, '@dapAn')">
                        <label class="form-check-label"> @dapAn. @noiDung </label>
                    </div>
                }
            </div>
        }
    </form>

    <form asp-action="NopBai" method="post">
        <input type="hidden" name="lichSuId" value="@lichSuId" />
        <button type="submit" class="btn btn-success">Nộp bài</button>
    </form>
</div>

@section Scripts {
    <script>
        // Đếm ngược
        let timeLeft = @thoiGian;
        const countdown = document.getElementById("countdown");
        const timer = setInterval(() => {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            timeLeft--;

            if (timeLeft < 0) {
                clearInterval(timer);
                document.querySelector("form[asp-action='NopBai']").submit();
            }
        }, 1000);

        // AJAX lưu đáp án từng câu
        function luuDapAn(lichSuId, cauHoiId, dapAnChon) {
            fetch('/Thi/LuuDapAn', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `lichSuId=${lichSuId}&cauHoiId=${cauHoiId}&dapAnChon=${dapAnChon}`
            }).then(res => {
                if (!res.ok) {
                    alert('Lưu đáp án thất bại!');
                }
            });
        }
    </script>
}
